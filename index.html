<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ù†Ø³Ø§Ù† Ø­ÙŠÙˆØ§Ù† ğŸ¦</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-purple: #4a148c; 
            --primary: #ffeb3b; 
            --secondary: #00e676; 
            --red: #f44336; 
            --text: #fff;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Tajawal', sans-serif;
            background-color: #121212;
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }
        .active { display: flex; }

        /* --- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ù‡Ø¨ÙˆØ· --- */
        #scr-landing {
            background: radial-gradient(circle, #4a148c 0%, #000 100%);
        }
        .title-huge { font-size: 4rem; margin-bottom: 20px; color: var(--primary); text-shadow: 0 0 20px var(--primary); }
        .btn-main {
            background: white; color: var(--bg-purple); border: none;
            padding: 15px 50px; font-size: 1.5rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 5px 15px rgba(255,255,255,0.3);
        }
        .btn-main:hover { transform: scale(1.1); }

        /* --- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ --- */
        #scr-connect { background: #222; }
        .qr-box { background: white; padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; }
        .qr-img { width: 300px; height: 300px; }
        .qr-tiny { width: 80px; height: 80px; }

        /* --- 3. Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ† --- */
        #scr-tv {
            background: linear-gradient(135deg, #1a237e 0%, #000 100%);
            justify-content: flex-start; padding-top: 40px;
        }
        
        .letter-display {
            font-size: 8rem; font-weight: 900; color: var(--primary);
            border: 5px solid white; border-radius: 50%; width: 200px; height: 200px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.1); margin-bottom: 20px;
            box-shadow: 0 0 30px var(--primary);
        }

        .status-bar {
            font-size: 2rem; color: white; margin-bottom: 30px; font-weight: bold;
        }

        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; width: 95%; overflow-y: auto; padding: 20px;
        }

        .result-card {
            background: white; color: black; border-radius: 15px; padding: 15px;
            text-align: right; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .res-name { font-weight: 900; color: var(--bg-purple); font-size: 1.4rem; border-bottom: 2px solid #eee; margin-bottom: 10px; }
        .res-item { display: flex; justify-content: space-between; font-size: 1.1rem; margin: 5px 0; }
        .res-lbl { color: #666; font-size: 0.9rem; }

        /* --- 4. Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ --- */
        #scr-player { background: #f5f5f5; color: #333; justify-content: flex-start; overflow-y: auto; padding: 20px; }
        
        .p-header { 
            width: 100%; display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; background: var(--bg-purple); padding: 15px; border-radius: 15px; color: white;
        }
        .current-letter { font-size: 2.5rem; font-weight: bold; color: var(--primary); }

        .game-input {
            width: 100%; padding: 15px; margin: 8px 0; font-size: 1.1rem;
            border: 2px solid #ddd; border-radius: 10px; font-family: 'Tajawal';
        }
        .game-input:focus { border-color: var(--bg-purple); outline: none; }

        .btn-stop {
            width: 100%; padding: 20px; background: var(--red); color: white;
            font-size: 2rem; font-weight: 900; border: none; border-radius: 15px;
            margin-top: 20px; cursor: pointer; box-shadow: 0 5px 0 #b71c1c;
        }
        .btn-stop:active { transform: translateY(5px); box-shadow: none; }
        .btn-stop:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* --- 5. Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù‚Ø¯Ù… --- */
        #scr-admin { background: #eee; color: #333; justify-content: flex-start; padding: 20px; overflow-y: auto; }
        .admin-panel { width: 100%; max-width: 500px; }
        .admin-btn { width: 100%; padding: 15px; margin: 5px 0; border:none; border-radius: 10px; font-size: 1.2rem; font-weight:bold; cursor: pointer; color:white; }
        
        .char-select {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin: 15px 0;
        }
        .char-btn {
            background: white; border: 1px solid #ccc; padding: 10px; font-size: 1.2rem; cursor: pointer; border-radius: 5px;
        }
        .char-btn.selected { background: var(--bg-purple); color: white; }

        /* Lock Overlay */
        #stop-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(244, 67, 54, 0.95); z-index: 999;
            flex-direction: column; justify-content: center; align-items: center; color: white;
        }
    </style>
</head>
<body>

    <div id="stop-overlay">
        <h1 style="font-size: 5rem;">âœ‹ Ù‚Ù!</h1>
        <h2 id="stopper-name">...</h2>
        <p>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©</p>
    </div>

    <div id="scr-landing" class="screen active">
        <div class="title-huge">Ø¥Ù†Ø³Ø§Ù† Ø­ÙŠÙˆØ§Ù†</div>
        <button class="btn-main" onclick="createGame()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ğŸ²</button>
    </div>

    <div id="scr-connect" class="screen">
        <h2 style="color:white; margin-bottom:10px">Ø§Ù…Ø³Ø­ Ù„Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div class="qr-box">
            <div id="qr-players"></div>
        </div>
        <button class="btn-main" style="background:var(--secondary); color:black;" onclick="goTV()">Ø¨Ø¯Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ğŸ“º</button>
        
        <div style="position:absolute; bottom:20px; left:20px; background:white; padding:5px; border-radius:10px;">
            <div id="qr-admin" class="qr-tiny"></div>
            <div style="color:black; font-size:0.7rem; font-weight:bold; text-align:center;">Ù…Ù‚Ø¯Ù…</div>
        </div>
    </div>

    <div id="scr-tv" class="screen">
        <div class="letter-display" id="tv-char">?</div>
        <div class="status-bar" id="tv-status">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…...</div>
        <div id="tv-results" class="results-grid"></div>
    </div>

    <div id="scr-player" class="screen">
        <div id="p-login" style="width:100%; text-align:center; margin-top:50px;">
            <h2>Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ</h2>
            <input type="text" id="p-name-in" class="game-input" style="text-align:center;" placeholder="Ø§Ù„Ø§Ø³Ù…...">
            <button class="btn-main" style="background:var(--bg-purple); color:white; width:100%;" onclick="pLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="p-game" style="display:none; width:100%;">
            <div class="p-header">
                <div>Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</div>
                <div class="current-letter" id="p-char">?</div>
            </div>

            <input type="text" id="in-human" class="game-input" placeholder="Ø¥Ù†Ø³Ø§Ù† (ÙˆÙ„Ø¯/Ø¨Ù†Øª)">
            <input type="text" id="in-animal" class="game-input" placeholder="Ø­ÙŠÙˆØ§Ù†">
            <input type="text" id="in-plant" class="game-input" placeholder="Ù†Ø¨Ø§Øª">
            <input type="text" id="in-object" class="game-input" placeholder="Ø¬Ù…Ø§Ø¯">
            <input type="text" id="in-country" class="game-input" placeholder="Ø¨Ù„Ø§Ø¯">

            <button class="btn-stop" id="btn-stop-game" onclick="stopRoundByPlayer()">âœ‹ Ù‚Ù€Ù€Ù€Ù€Ù€Ù€Ù!</button>
        </div>
        
        <div id="p-wait" style="display:none; text-align:center; margin-top:50px;">
            <h2>Ø§Ù†ØªØ¸Ø± Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø©...</h2>
            <div style="font-size:3rem;">â³</div>
        </div>
    </div>

    <div id="scr-admin" class="screen">
        <div class="admin-panel">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:20px;">
                <h3>Ø§Ø®ØªØ± Ø§Ù„Ø­Ø±Ù:</h3>
                <div id="chars-grid" class="char-select"></div>
                <div style="text-align:center; font-size:2rem; font-weight:bold; color:var(--bg-purple);" id="adm-selected-char">?</div>
            </div>

            <button class="admin-btn" style="background:var(--secondary); color:black;" onclick="startRound()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
            <button class="admin-btn" style="background:var(--red);" onclick="forceStop()">ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</button>
            <button class="admin-btn" style="background:var(--primary); color:black;" onclick="showResults()">ğŸ‘€ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button class="admin-btn" style="background:#333;" onclick="resetRound()">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDh4v9gRCICA_XRCJXsDpbtCySYAoFsfhk",
            authDomain: "bagera-word.firebaseapp.com",
            databaseURL: "https://bagera-word-default-rtdb.firebaseio.com",
            projectId: "bagera-word",
            storageBucket: "bagera-word.firebasestorage.app",
            messagingSenderId: "53001885470",
            appId: "1:53001885470:web:c6649f9f259824f747db0f"
        };
        try { if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig); else firebase.app(); } catch(e) {}
        const db = firebase.database();

        const arabicChars = "Ø£Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ".split('');
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        let role = urlParams.get('role');
        let myId = localStorage.getItem('insan_myId') || Date.now().toString();
        localStorage.setItem('insan_myId', myId);
        let selectedChar = '';

        window.onload = function() {
            if(!roomId) {
                // Landing
            } else if(role === 'admin') {
                initAdmin();
            } else if(role === 'player') {
                showScreen('scr-player');
            } else {
                showScreen('scr-connect');
                generateQRs();
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function createGame() {
            roomId = Math.random().toString(36).substr(2, 6);
            const newUrl = window.location.href.split('?')[0] + `?room=${roomId}`;
            window.history.pushState({path:newUrl}, '', newUrl);
            
            db.ref(`insan/${roomId}`).set({
                state: 'lobby',
                char: '?',
                stopper: null
            });
            
            showScreen('scr-connect');
            generateQRs();
        }

        function generateQRs() {
            const base = window.location.href.split('?')[0];
            const pUrl = `${base}?room=${roomId}&role=player`;
            const aUrl = `${base}?room=${roomId}&role=admin`;
            
            document.getElementById('qr-players').innerHTML = `<img class="qr-img" src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(pUrl)}" />`;
            document.getElementById('qr-admin').innerHTML = `<img class="qr-tiny" src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(aUrl)}" />`;
        }

        function goTV() {
            showScreen('scr-tv');
            initTV();
        }

        // --- TV Logic ---
        function initTV() {
            db.ref(`insan/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                document.getElementById('tv-char').innerText = data.char;
                
                const status = document.getElementById('tv-status');
                const overlay = document.getElementById('stop-overlay');
                const resGrid = document.getElementById('tv-results');

                if(data.state === 'lobby') {
                    status.innerText = "Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†...";
                    overlay.style.display = 'none';
                    resGrid.innerHTML = '';
                } else if(data.state === 'playing') {
                    status.innerText = "Ø§Ù†Ø·Ù„Ù‚ÙˆØ§! ğŸ";
                    status.style.color = "#00e676";
                    overlay.style.display = 'none';
                    resGrid.innerHTML = '';
                } else if(data.state === 'stopped') {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ù‚Ù
                    document.getElementById('stopper-name').innerText = data.stopper || "Ø§Ù„Ù…Ù‚Ø¯Ù…";
                    overlay.style.display = 'flex';
                    status.innerText = "ØªÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨!";
                } else if(data.state === 'results') {
                    overlay.style.display = 'none';
                    status.innerText = "Ø§Ù„Ù†ØªØ§Ø¦Ø¬:";
                    renderResults(data.players);
                }
            });
        }

        function renderResults(players) {
            const grid = document.getElementById('tv-results');
            grid.innerHTML = '';
            if(!players) return;

            Object.values(players).forEach(p => {
                if(p.answers) {
                    let html = `<div class="result-card"><div class="res-name">${p.name}</div>`;
                    html += `<div class="res-item"><span class="res-lbl">Ø¥Ù†Ø³Ø§Ù†:</span> <span>${p.answers.human || '-'}</span></div>`;
                    html += `<div class="res-item"><span class="res-lbl">Ø­ÙŠÙˆØ§Ù†:</span> <span>${p.answers.animal || '-'}</span></div>`;
                    html += `<div class="res-item"><span class="res-lbl">Ù†Ø¨Ø§Øª:</span> <span>${p.answers.plant || '-'}</span></div>`;
                    html += `<div class="res-item"><span class="res-lbl">Ø¬Ù…Ø§Ø¯:</span> <span>${p.answers.object || '-'}</span></div>`;
                    html += `<div class="res-item"><span class="res-lbl">Ø¨Ù„Ø§Ø¯:</span> <span>${p.answers.country || '-'}</span></div>`;
                    html += `</div>`;
                    grid.innerHTML += html;
                }
            });
        }

        // --- Player Logic ---
        function pLogin() {
            const name = document.getElementById('p-name-in').value.trim();
            if(!name) return;
            
            db.ref(`insan/${roomId}/players/${myId}`).update({ name: name });
            
            document.getElementById('p-login').style.display = 'none';
            listenPlayerState(name);
        }

        function listenPlayerState(name) {
            db.ref(`insan/${roomId}`).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                const pWait = document.getElementById('p-wait');
                const pGame = document.getElementById('p-game');
                const overlay = document.getElementById('stop-overlay');
                
                document.getElementById('p-char').innerText = data.char;

                if(data.state === 'playing') {
                    pWait.style.display = 'none';
                    pGame.style.display = 'block';
                    overlay.style.display = 'none';
                    
                    // ÙØªØ­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                    enableInputs(true);
                } else if (data.state === 'stopped') {
                    // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
                    enableInputs(false);
                    submitAnswers(); // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø§ ØªÙ… ÙƒØªØ§Ø¨ØªÙ‡
                    
                    document.getElementById('stopper-name').innerText = data.stopper;
                    overlay.style.display = 'flex';
                } else {
                    pWait.style.display = 'block';
                    pGame.style.display = 'none';
                    overlay.style.display = 'none';
                    clearInputs();
                }
            });
        }

        function enableInputs(enable) {
            const inputs = document.querySelectorAll('.game-input');
            const btn = document.getElementById('btn-stop-game');
            inputs.forEach(i => i.disabled = !enable);
            btn.disabled = !enable;
        }

        function clearInputs() {
            document.querySelectorAll('.game-input').forEach(i => i.value = '');
        }

        function stopRoundByPlayer() {
            // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¶ØºØ· Ù‚Ù
            const name = document.getElementById('p-name-disp')?.innerText || "Ù„Ø§Ø¹Ø¨"; // fallback
            // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ùˆ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ³ Ø§ÙØ¶Ù„ØŒ Ø¨Ø³ Ù„Ù„Ø³Ø±Ø¹Ø©:
            db.ref(`insan/${roomId}/players/${myId}/name`).once('value', snap => {
                const myName = snap.val() || "Ù…Ø¬Ù‡ÙˆÙ„";
                submitAnswers().then(() => {
                    db.ref(`insan/${roomId}`).update({
                        state: 'stopped',
                        stopper: myName
                    });
                });
            });
        }

        function submitAnswers() {
            const ans = {
                human: document.getElementById('in-human').value,
                animal: document.getElementById('in-animal').value,
                plant: document.getElementById('in-plant').value,
                object: document.getElementById('in-object').value,
                country: document.getElementById('in-country').value
            };
            return db.ref(`insan/${roomId}/players/${myId}/answers`).set(ans);
        }

        // --- Admin Logic ---
        function initAdmin() {
            showScreen('scr-admin');
            const grid = document.getElementById('chars-grid');
            arabicChars.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'char-btn';
                btn.innerText = c;
                btn.onclick = () => {
                    document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedChar = c;
                    document.getElementById('adm-selected-char').innerText = c;
                    db.ref(`insan/${roomId}/char`).set(c);
                };
                grid.appendChild(btn);
            });
        }

        function startRound() {
            if(selectedChar === '') return alert("Ø§Ø®ØªØ± Ø­Ø±Ù Ø£ÙˆÙ„Ø§Ù‹");
            // ØªØµÙÙŠØ± Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            db.ref(`insan/${roomId}/players`).once('value', snap => {
                snap.forEach(p => {
                    p.ref.child('answers').remove();
                });
                db.ref(`insan/${roomId}`).update({ state: 'playing', stopper: null });
            });
        }

        function forceStop() {
            db.ref(`insan/${roomId}`).update({ state: 'stopped', stopper: "Ø§Ù„Ù…Ù‚Ø¯Ù…" });
        }

        function showResults() {
            db.ref(`insan/${roomId}`).update({ state: 'results' });
        }

        function resetRound() {
            db.ref(`insan/${roomId}`).update({ state: 'lobby', char: '?' });
            document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
            selectedChar = '';
            document.getElementById('adm-selected-char').innerText = '?';
        }

    </script>
</body>
</html>